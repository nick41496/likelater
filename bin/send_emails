#!/usr/bin/env node

const _ = require('lodash');
const async = require('async');
const fs = require('fs');
const handlebars = require('handlebars');
const pg = require('pg');
const twitter = require('twitter');

const twitter_client = new twitter({
    consumer_key: process.env.CONSUMER_KEY,
    consumer_secret: process.env.CONSUMER_SECRET,
    bearer_token: process.env.BEARER_TOKEN
});

fs.readFile('../email_template.html', (err, email_template) => {
    pg.connect(process.env.DATABASE_URL, (err, client, done) => {
        client.query('SELECT * from users WHERE active=TRUE', (err, result) => {
            done();

            if (err) {
                console.error(err);
                return;
            }

            const users = result.rows;

            _.forEach(users, (user) => {
                _.forEach(user.handles, (handle) => {
                    let get_options;
                    if (user.latest_tweet) {
                        get_options = {
                            screen_name: handle,
                            since_id: user.latest_tweet,
                            count: '200'
                        }
                    } else {
                        get_options = {
                            screen_name: handle,
                            count: '200'
                        }
                    }

                    twitter_client.get('favorites/list', get_options, (err, tweets) => {
                        if (err) {
                            console.log('error');
                            console.error(err);
                            return;
                        }
                        link_tweets = _.filter(tweets, (tweet) => {
                            const urls = _.filter(tweet['entities']['urls'], (url) => {
                                return !/twitter\.com\/.*\/status\//g.test(url.expanded_url);
                            });
                            return urls.length > 0;
                        });
                        const tweet_htmls = [];
                        async.each(link_tweets, (tweet) => {
                            twitter_client.get('statuses/oembed', {
                                url: `https://twitter.com/${tweet.user.screen_name}/status/${tweet.id_str}`,
                                hide_media: true
                            }, (err, tweet) => {
                                if (err) {
                                    console.error(err);
                                    throw err;
                                }
                                console.log(tweet);
                                tweet_htmls.push(tweet);
                            });
                        }, (err) => {
                            if (err) {
                                console.error(err);
                                throw err;
                            }
                            console.log(tweet_htmls);
                        });
                    });
                });
            });
        });
    });
});
